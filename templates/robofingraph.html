<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Financial Analyzer</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-900">
<div id="root" class="max-w-7xl mx-auto p-6"></div>

{% raw %}
<script type="text/babel">
const { useState, useEffect, useRef } = React;

// ============================================================================
// GLOBAL CONSTANTS AND UTILITIES
// Starts: here
// Purpose: Shared constants and helper functions
// Ends: before Icon Components section
// Closed by: end of utility declarations
// ============================================================================

const SETUP_STEPS_LIST = [
  { key: "api", label: "Setting up APIs" },
  { key: "llm", label: "Setting up LLM Model" },
  { key: "agents", label: "Setting up Agents" },
  { key: "tools", label: "Setting up Tools" },
  { key: "region", label: "Resolving Company Region & Peers" },
];

const STATUS_COLOR = {
  pending: "bg-yellow-400",
  success: "bg-green-500",
  error: "bg-red-500",
};

const AGENT_ROLES_FOR_MODEL_ASSIGNMENT = [
  "Get_Company_Details", "Check_Region", "US_Data_Collection", "India_Data_Collection",
  "Validate_Collected_Data", "Synchronize_Data", "Summarize_Data", "Validate_Summarized_Data",
  "Conceptual_Analysis", "Validate_Conceptual_Analysis", "Generate_Annual_Report", "Run_Evaluation"
];

// Converts snake_case agent role key to Title Case
const formatAgentRoleKey = (key) => key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());

// ============================================================================
// ICON COMPONENTS
// Starts: here
// Purpose: SVG icon React components for UI
// Ends: before UI Components section
// Closed by: end of last icon component
// ============================================================================

const IconKey = () => (
  <svg className="h-4 w-4 text-gray-400 mr-1" fill="none" viewBox="0 0 24 24">
    <circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2"/>
    <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" stroke="currentColor" strokeWidth="2"/>
  </svg>
);

const IconLLM = () => (
  <svg className="h-4 w-4 text-purple-400 mr-1" fill="none" viewBox="0 0 24 24">
    <rect x="4" y="4" width="16" height="16" stroke="currentColor" strokeWidth="2"/>
    <circle cx="12" cy="12" r="3" stroke="currentColor" strokeWidth="2"/>
  </svg>
);

const IconPipeline = () => (
  <svg className="h-4 w-4 text-green-400 mr-1" fill="none" viewBox="0 0 24 24">
    <rect x="4" y="10" width="16" height="4" stroke="currentColor" strokeWidth="2"/>
    <circle cx="8" cy="12" r="2" stroke="currentColor" strokeWidth="2"/>
    <circle cx="16" cy="12" r="2" stroke="currentColor" strokeWidth="2"/>
  </svg>
);

const IconSpinner = () => (
  <svg className="animate-spin h-5 w-5 mr-2 text-blue-500" viewBox="0 0 24 24" fill="none">
    <circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
  </svg>
);

const IconGraph = () => (
  <svg className="h-5 w-5 text-indigo-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
    <path strokeLinecap="round" strokeLinejoin="round" d="M3 6l3 3m0 0l-3 3m3-3h12m-9 1l4-4m0 0l4 4m-4-4v14" />
  </svg>
);

const IconAgent = () => (
  <svg className="h-5 w-5 text-blue-600 mr-2" fill="none" viewBox="0 0 24 24">
    <circle cx="12" cy="8" r="3.5" stroke="currentColor" strokeWidth="1.5" />
    <path d="M5 15C5 12.2386 7.23858 10 10 10H14C16.7614 10 19 12.2386 19 15V16C19 17.1046 18.1046 18 17 18H7C5.89543 18 5 17.1046 5 16V15Z"
          stroke="currentColor" strokeWidth="1.5" />
  </svg>
);

// ============================================================================
// UI COMPONENTS
// Starts: here
// Purpose: All major UI components for the dashboard
// Ends: before Main Application Component section
// Closed by: end of last UI component
// ============================================================================

/**
 * LoggingSetupStatus
 * Starts: here
 * Purpose: Displays the setup progress (APIs, LLM, Agents, etc.)
 * Ends: at end of function definition
 * Closed by: function block }
 */
function LoggingSetupStatus({ setupStatus }) {
  return (
    <div className="bg-white rounded-lg shadow p-4 mb-4">
      <div className="font-semibold mb-2">Setup Progress</div>
      <table className="w-full text-xs">
        <tbody>
          {SETUP_STEPS_LIST.map((step) => (
            <tr key={step.key}>
              <td className="pr-2 py-1">
                <span
                  className={`inline-block w-4 h-4 rounded-full border border-gray-300 ${STATUS_COLOR[setupStatus[step.key] || "pending"]}`}
                  title={setupStatus[step.key]}
                ></span>
              </td>
              <td className="py-1">{step.label}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
} // Ends LoggingSetupStatus

/**
 * CompanyDetails
 * -----------------------------------------------------------------------------
 * Purpose: Renders Company Information after resolving it.
 * Props:
 * - details (object): Company information fields.
 * -----------------------------------------------------------------------------
 */
function CompanyDetails({ details }) {
  // Helper to render array/object fields as a readable string
  const renderField = (value) => {
    if (Array.isArray(value)) {
      // If array of objects, try to show main property, else JSON
      return value.map(item =>
        typeof item === "object"
          ? item.company_name || JSON.stringify(item)
          : item
      ).join(", ");
    }
    if (typeof value === "object" && value !== null) {
      // For objects, show JSON string
      return JSON.stringify(value);
    }
    // For primitives, show as-is or fallback
    return value || "â€”";
  };

  return (
    <div className="bg-white rounded-lg shadow p-4 mb-4">
      <div className="font-semibold mb-2">Company Details</div>
      <table className="w-full text-xs">
        <tbody>
          <tr><td className="font-medium pr-2 py-1">Official Name:</td><td>{renderField(details.official_name)}</td></tr>
          <tr><td className="font-medium pr-2 py-1">Company Name:</td><td>{renderField(details.company_name)}</td></tr>
          <tr><td className="font-medium pr-2 py-1">Segments:</td><td>{renderField(details.segments)}</td></tr>
          <tr><td className="font-medium pr-2 py-1">Industry:</td><td>{renderField(details.industry)}</td></tr>
          <tr><td className="font-medium pr-2 py-1">FMP Ticker:</td><td>{renderField(details.fmp_ticker)}</td></tr>
          <tr><td className="font-medium pr-2 py-1">SEC Ticker:</td><td>{renderField(details.sec_ticker)}</td></tr>
          <tr><td className="font-medium pr-2 py-1">Yahoo Finance Ticker:</td><td>{renderField(details.yfinance_ticker)}</td></tr>
          <tr><td className="font-medium pr-2 py-1">Region:</td><td>{renderField(details.region)}</td></tr>
          <tr><td className="font-medium pr-2 py-1">Currency:</td><td>{renderField(details.currency)}</td></tr>
          <tr><td className="font-medium pr-2 py-1">Peers:</td><td>{renderField(details.peers)}</td></tr>
        </tbody>
      </table>
    </div>
  );
}

/**
 * GraphViewer Component
 * -----------------------------------------------------------------------------
 * Purpose: Renders a Mermaid.js workflow graph inside a styled container.
 * 
 * Props:
 * - mermaidSyntax (string): Mermaid.js graph definition.
 * 
 * Behavior:
 * - Uses a ref to inject the rendered Mermaid SVG into the DOM.
 * - Handles errors gracefully and displays a message if rendering fails.
 * - Shows a waiting message if no Mermaid syntax is provided.
 * -----------------------------------------------------------------------------
 */

function GraphViewer({ mermaidSyntax }) {
  const graphRef = React.useRef(null);

  React.useEffect(() => {
    if (!mermaidSyntax || !window.mermaid) {
      return;
    }

    const container = graphRef.current;
    if (!container) {
      return;
    }

    // Clear previous graph content
    container.innerHTML = '';

    // Render Mermaid graph asynchronously
    window.mermaid.render('workflowSvg', mermaidSyntax)
      .then(({ svg }) => {
        container.innerHTML = svg;
      })
      .catch((error) => {
        container.innerHTML = `<pre style="color: red;">Mermaid render error: ${error.message}</pre>`;
      });
  }, [mermaidSyntax]);

  return (
    <div className="bg-white rounded-lg shadow p-4 mb-8 mt-8">
      <div className="font-semibold mb-4 flex items-center">
        <IconGraph />
        Workflow Graph
      </div>
      <div
        ref={graphRef}
        id="mermaid-graph"
        className="overflow-auto"
        style={{
          minHeight: '700px',
          maxHeight: '1250px',
          border: '1px solid #ececec',
          borderRadius: '10px',
          background: '#fcfcfc',
          width: '100%',
          maxWidth: '100%',
        }}
      >
        {!mermaidSyntax && (
          <div
            className="flex items-center justify-center text-gray-400 text-xs"
            style={{ minHeight: '400px' }}
          >
            Waiting for graph definition...
          </div>
        )}
      </div>
    </div>
  );
} // Ends GraphViewer

function generateMermaidSyntax(nodeStatus, edgeStatus) {
  let syntax = `
    graph TD
      Get_Company_Details("Get Company Details")
      Check_Region("Check Region")
      US_Data_Collection("US Data Collection")
      India_Data_Collection("Data Collection India")
      Validate_Collected_Data("Validate Collected Data")
      Synchronize_Data("Synchronize Data")
      Summarize_Data("Summarize Data")
      Validate_Summarized_Data("Validate Summarized Data")
      Conceptual_Analysis("Conceptual Analysis")
      Validate_Conceptual_Analysis("Validate Conceptual Analysis")
      Generate_Annual_Report("Generate Annual Report")
      Run_Evaluation("Run Evaluation")
      __start__([__start__])
      __end__([__end__])

      __start__ --> Get_Company_Details
      Get_Company_Details --> Check_Region
      Check_Region -. india .-> India_Data_Collection
      Check_Region -. us .-> US_Data_Collection
      Check_Region -. end .-> __end__
      US_Data_Collection --> Validate_Collected_Data
      India_Data_Collection --> Validate_Collected_Data
      Validate_Collected_Data -. continue .-> Synchronize_Data
      Validate_Collected_Data -. end .-> __end__
      Synchronize_Data --> Summarize_Data
      Summarize_Data --> Validate_Summarized_Data
      Validate_Summarized_Data -. continue .-> Conceptual_Analysis
      Validate_Summarized_Data -. end .-> __end__
      Conceptual_Analysis --> Validate_Conceptual_Analysis
      Validate_Conceptual_Analysis -. continue .-> Generate_Annual_Report
      Validate_Conceptual_Analysis -. end .-> __end__
      Generate_Annual_Report --> Run_Evaluation
      Run_Evaluation --> __end__
  `;

  syntax += `
    classDef completed fill:#d1fae5,stroke:#059669,stroke-width:2px;
    classDef running fill:#fef9c3,stroke:#eab308,stroke-width:2px;
    classDef error fill:#fee2e2,stroke:#dc2626,stroke-width:2px;
    classDef pending fill:#f3f4f6,stroke:#9ca3af,stroke-width:1px;
  `;

  // Assign node classes
  Object.entries(nodeStatus).forEach(([node, status]) => {
    syntax += `\n  class ${node} ${status};`;
  });

  // Assign edge colors dynamically
  edgeStatus.forEach((status, idx) => {
    let color;
    if (status === "running") color = "#eab308";      // yellow
    else if (status === "completed") color = "#059669"; // green
    else if (status === "error") color = "#dc2626";     // red
    else color = "#9ca3af";                             // gray/pending
    syntax += `\n  linkStyle ${idx} stroke:${color},stroke-width:3px;`;
  });

  return syntax;
}

function formatModelName(model) {
  // Remove everything before the last '/'
  let name = model.includes('/') ? model.split('/').pop() : model;
  // Remove only trailing date pattern (e.g., -2025-04-14)
  name = name.replace(/-\\d{4}-\\d{2}-\\d{2}$/, '');
  return name;
}

/**
 * AnalysisConfig
 * Starts: here
 * Purpose: Panel for configuring company, year, report type, verbose mode, and LLM provider.
 * Ends: at end of arrow function
 * Closed by: arrow function block }
 */
const AnalysisConfig = ({
  company, setCompany,
  year, setYear,
  reportType, setReportType,
  selectedGlobalProvider, setSelectedGlobalProvider,
  availableProviders,
  isRunning, onStart,
  verbose, setVerbose
}) => {
  const providerOptions = Object.keys(availableProviders).map(key => ({
    key: key,
    name: formatAgentRoleKey(key.replace(/_llm_models$/, ''))
  }));

  return (
    <div className="bg-white rounded-lg shadow p-4 mb-4">
      <div className="flex items-center font-semibold mb-2">
        <IconKey />
        Analysis Configuration
      </div>
      <div className="mb-2">
        <label className="block text-xs text-gray-500">Company Name or Ticker</label>
        <input
          className="border px-2 py-1 rounded w-full"
          value={company}
          onChange={e => setCompany(e.target.value)}
          disabled={isRunning}
        />
      </div>
      <div className="flex gap-2 mb-2">
        <div className="flex-1">
          <label className="block text-xs text-gray-500">Year</label>
          <select
            className="border px-2 py-1 rounded w-full"
            value={year}
            onChange={e => setYear(e.target.value)}
            disabled={isRunning}
          >
            {[2025,2024,2023,2022,2021].map(y => (
              <option key={y} value={y}>{y}</option>
            ))}
          </select>
        </div>
        <div className="flex-1">
          <label className="block text-xs text-gray-500">Report Type</label>
          <select
            className="border px-2 py-1 rounded w-full"
            value={reportType}
            onChange={e => setReportType(e.target.value)}
            disabled={isRunning}
          >
            <option value="kpi_bullet_insights">KPI Insights</option>
          </select>
        </div>
      </div>
      <div className="mb-3">
        <label className="inline-flex items-center">
          <input
            type="checkbox"
            className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
            checked={verbose}
            onChange={e => setVerbose(e.target.checked)}
            disabled={isRunning}
          />
          <span className="ml-2 text-sm">Verbose (debug logging)</span>
        </label>
      </div>
      {/* Global LLM Provider Selection */}
      <div className="mb-3">
        <label htmlFor="global-provider-select" className="block text-xs text-gray-500 mb-2">
          Select Main LLM Provider for all Agents
        </label>
        <select
          id="global-provider-select"
          className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
          value={selectedGlobalProvider || ''}
          onChange={(e) => setSelectedGlobalProvider(e.target.value)}
          disabled={isRunning || !providerOptions.length}
        >
          {!providerOptions.length && <option value="">No providers available</option>}
          {providerOptions.map(provider => (
            <option key={provider.key} value={provider.key}>
              {provider.name}
            </option>
          ))}
        </select>
      </div>
      {/* Displaying selected LLM Models per agent (read-only) */}
      {selectedGlobalProvider && availableProviders[selectedGlobalProvider] && (
        <div className="mb-4 p-3 bg-gray-50 rounded-md border border-gray-200">
          <h4 className="font-semibold text-sm mb-2 text-gray-700">
            Selected Models from {providerOptions.find(p => p.key === selectedGlobalProvider)?.name || 'Provider'}:
          </h4>
          <div className="overflow-x-auto">
            <table className="table-auto w-full text-xs border border-gray-200">
              <tbody>
                {Object.entries(availableProviders[selectedGlobalProvider]).map(([agentRoleKey, modelName]) => (
                  <tr key={agentRoleKey} className="hover:bg-gray-100">
                    <td className="px-2 py-1 border-b border-gray-100">
                      <span className="font-medium text-gray-800 capitalize">{formatAgentRoleKey(agentRoleKey)}</span>
                      <br />
                      <span className="text-gray-600" style={{ fontSize: '0.95em' }}>{formatModelName(modelName)}</span>
                    </td>
                  </tr>
                ))}
              </tbody>

            </table>
          </div>
        </div>
      )}
      {/* Disable if no provider selected */}
      <button
        className="w-full py-2 bg-indigo-600 text-white rounded font-semibold flex items-center justify-center"
        onClick={onStart}
        disabled={isRunning || !selectedGlobalProvider}
      >
        {isRunning ? <><IconSpinner /> Processing...</> : "Start Analysis"}
      </button>
    </div>
  );
}; // Ends AnalysisConfig

/**
 * LLMUsage
 * Starts: here
 * Purpose: Shows total number of LLM calls made.
 * Ends: after arrow function
 * Closed by: arrow function block }
 */
const LLMUsage = ({ llmCalls }) => (
  <div className="bg-white rounded-lg shadow p-4 mb-4">
    <div className="flex items-center font-semibold mb-2">
      <IconLLM />
      LLM Usage
    </div>
    <div className="text-xs text-gray-500">
      {llmCalls === 0 ? "No LLM calls yet." : `${llmCalls} LLM call${llmCalls > 1 ? "s" : ""} made.`}
    </div>
  </div>
); // Ends LLMUsage

/**
 * PipelineKPIs
 * Starts: here
 * Purpose: Shows pipeline KPIs and download link for report.
 * Ends: after arrow function
 * Closed by: arrow function block }
 */
const PipelineKPIs = ({ kpis, reportUrl }) => {
  const toolSuccess = kpis.tool_calls > 0
    ? `${kpis.successful_tool_calls}/${kpis.tool_calls}`
    : "N/A";
  return (
    <div className="bg-white rounded-lg shadow p-4">
      <div className="flex items-center font-semibold mb-2">
        <IconPipeline />
        Pipeline KPIs
      </div>
      <div className="text-xs">
        <div className="flex justify-between"><span>End-to-End Latency:</span> <span>{kpis.latency?.toFixed(2) ?? "N/A"}s</span></div>
        <div className="flex justify-between"><span>Total LLM Tokens:</span> <span>{kpis.tokens ?? "N/A"}</span></div>
        <div className="flex justify-between"><span>Estimated LLM Cost:</span> <span>${kpis.cost?.toFixed(5) ?? "N/A"}</span></div>
        <div className="flex justify-between mt-2 text-gray-400"><span>LLM-as-Judge Metrics (Post-run)</span></div>
        <div className="flex justify-between"><span>Accuracy:</span> <span>{kpis.accuracy ?? "N/A"}</span></div>
        <div className="flex justify-between"><span>Logicality:</span> <span>{kpis.logicality ?? "N/A"}</span></div>
        <div className="flex justify-between"><span>Storytelling:</span> <span>{kpis.storytelling ?? "N/A"}</span></div>
      </div>
      {reportUrl && (
        <a
          href={reportUrl}
          className="mt-3 block py-2 bg-green-600 text-white text-center rounded font-semibold hover:bg-green-700"
          download
        >
          Download Report
        </a>
      )}
    </div>
  );
};
 // Ends PipelineKPIs

/**
 * AgentSetupViewer
 * Starts: here
 * Purpose: Shows the agent setup (leader and agents) and region.
 * Ends: at end of function definition
 * Closed by: function block }
 */
function AgentSetupViewer({ region, agentSetup }) {
  if (!agentSetup || !agentSetup.leader || !agentSetup.agents) {
    return (
      <div className="bg-white rounded-lg shadow p-4 mb-4">
        <div className="flex items-center font-semibold mb-2">
          <IconAgent />
          Agent Setup: {region === "IN" ? "India" : "US"}
        </div>
        <div className="text-gray-400 text-xs">Loading agent details...</div>
      </div>
    );
  }
  return (
    <div className="bg-white rounded-lg shadow p-4 mb-4 max-h-[400px] overflow-y-auto">
      <section className="mb-4">
        <h3 className="font-semibold text-md mb-2 flex items-center">
          <svg className="h-4 w-4 text-yellow-500 mr-1" fill="none" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="8" stroke="currentColor" strokeWidth="1.5" />
            <path d="M12 8V12M12 12L14 14" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" />
          </svg>
          Leader
        </h3>
        <div className="ml-5">
          <p className="font-semibold">{agentSetup.leader.title}</p>
          <ul className="list-disc list-inside text-sm text-gray-700">
            {agentSetup.leader.responsibilities.map((resp, idx) => (
              <li key={idx}>{resp}</li>
            ))}
          </ul>
        </div>
      </section>
      <section>
        <h3 className="font-semibold text-md mb-2 flex items-center">
          <svg className="h-4 w-4 text-gray-500 mr-1" fill="none" viewBox="0 0 24 24">
            <rect x="4" y="4" width="16" height="16" rx="2" stroke="currentColor" strokeWidth="1.5" />
            <path d="M8 12H16M12 8V16" stroke="currentColor" strokeWidth="1.5" strokeLinecap="round" />
          </svg>
          Agents
        </h3>
        <div className="ml-5 space-y-3">
          {agentSetup.agents.map((agent, idx) => (
            <div key={idx}>
              <p className="font-semibold text-sm">{agent.title}</p>
              <ul className="list-disc list-inside text-sm text-gray-600">
                {agent.responsibilities.map((resp, i) => (
                  <li key={i}>{resp}</li>
                ))}
              </ul>
            </div>
          ))}
        </div>
      </section>
    </div>
  );
} // Ends AgentSetupViewer

/**
 * AgentToolTable
 * Starts: here
 * Purpose: Table of agent and tool execution steps.
 * Ends: after arrow function
 * Closed by: arrow function block }
 */
const AgentToolTable = ({ agentSteps }) => (
  <div className="bg-white rounded-lg shadow p-4 mb-4">
    <div className="font-semibold mb-2">Agent & Tool Execution</div>
    <table className="min-w-full text-xs">
      <thead>
        <tr className="border-b">
          <th className="text-left py-1 px-2">AGENT</th>
          <th className="text-left py-1 px-2">TOOL</th>
          <th className="text-left py-1 px-2">STATUS</th>
          <th className="text-left py-1 px-2">DURATION</th>
        </tr>
      </thead>
      <tbody>
        {agentSteps.length === 0 ? (
          <tr>
            <td colSpan={4} className="py-2 text-gray-400 text-center">No agent steps yet.</td>
          </tr>
        ) : (
          agentSteps.map((step, i) => (
            <tr key={i} className="border-b last:border-0">
              <td className="py-1 px-2">{step.agentName}</td>
              <td className="py-1 px-2">{step.toolName}</td>
              <td className="py-1 px-2">
                {step.status === "Running" && <span className="text-blue-600">Running</span>}
                {step.status === "Completed" && <span className="text-green-600">Completed</span>}
                {step.status === "Error" && <span className="text-red-600">Error</span>}
              </td>
              <td className="py-1 px-2">
                {step.duration ? `${(step.duration / 1000).toFixed(2)} s` : "..."}
              </td>
            </tr>
          ))
        )}
      </tbody>
    </table>
  </div>
); // Ends AgentToolTable

/**
 * RawEventLog
 * Starts: here
 * Purpose: Displays the raw event log, parsing JSON lines for readability.
 * Ends: after arrow function
 * Closed by: arrow function block }
 */
const RawEventLog = ({ log }) => (
  <div className="bg-gray-900 rounded-lg shadow p-4 text-xs text-white font-mono h-40 overflow-y-auto">
    <div className="flex gap-4 mb-1">
      <span className="font-semibold text-gray-300">Raw Event Log</span>
    </div>
    <div>
      {log.length === 0
        ? <div className="text-gray-500">No events yet.</div>
        : log.map((line, i) => {
            try {
              const eventData = JSON.parse(line);
              // Prioritize displaying messages from 'log' events
              if (eventData.event_type === 'log' && eventData.data && eventData.data.message) {
                return <div key={i} className="text-gray-400">{eventData.data.message}</div>;
              }
              // For other structured events, display their type and stringified payload
              return <div key={i} className="text-blue-300">{eventData.event_type}: {JSON.stringify(eventData.payload || eventData.data, null, 2)}</div>;
            } catch (e) {
              // Fallback for non-JSON lines (should ideally not happen if backend is consistent)
              return <div key={i} className="text-red-400">Error parsing log line: {line}</div>;
            }
          })
      }
    </div>
  </div>
); // Ends RawEventLog

// ============================================================================
// MAIN APPLICATION COMPONENT
// Starts: here
// Purpose: The main React component containing all state, handlers, and layout
// Ends: at end of function definition
// Closed by: function block }
// ============================================================================
function App() {
  // --- State Management ---

  const [companyDetails, setCompanyDetails] = useState({
    official_name: "",
    company_name: "",
    segments: "",
    industry: "",
    fmp_ticker: "",
    sec_ticker: "",
    yfinance_ticker: "",
    region: "",
    currency: "",
    peers: ""
  });  
  const initialNodeStatus = {
    __start__: "pending",
    Get_Company_Details: "pending",
    Check_Region: "pending",
    US_Data_Collection: "pending",
    India_Data_Collection: "pending",
    Validate_Collected_Data: "pending",
    Synchronize_Data: "pending",
    Summarize_Data: "pending",
    Validate_Summarized_Data: "pending",
    Conceptual_Analysis: "pending",
    Validate_Conceptual_Analysis: "pending",
    Generate_Annual_Report: "pending",
    Run_Evaluation: "pending",
    __end__: "pending"
  };

  const initialEdgeStatus = [
    "pending", // Edge 0: __start__ --> Get_Company_Details
    "pending", // Edge 1: Get_Company_Details --> Check_Region
    // ...add more for each edge in your workflow
  ];


  // Declare state using useState
  const [nodeStatus, setNodeStatus] = React.useState(initialNodeStatus);
  const [edgeStatus, setEdgeStatus] = React.useState(initialEdgeStatus);

  // Now generate the Mermaid syntax using the current state
  const mermaidSyntax = generateMermaidSyntax(nodeStatus, edgeStatus);
  
  const closedByComplete = useRef(false);
  const [company, setCompany] = useState("DMART");
  const [year, setYear] = useState("2024");
  const [reportType, setReportType] = useState("kpi_bullet_insights");
  const [selectedGlobalProvider, setSelectedGlobalProvider] = useState("openai");
  const [isRunning, setIsRunning] = useState(false);
  const [error, setError] = useState(null);
  const [reportUrl, setReportUrl] = useState(null);
  const [availableProviders, setAvailableProviders] = useState({});

  const [isLoadingModels, setIsLoadingModels] = useState(true);
  const [verbose, setVerbose] = useState(false);
  const [agentSetup, setAgentSetup] = useState(null);
  const [setupStatus, setSetupStatus] = useState({
    api: "pending", llm: "pending", agents: "pending", tools: "pending", region: "pending",
  });
  const [agentSteps, setAgentSteps] = useState([]);
  const [log, setLog] = useState([]);
  const [llmCalls, setLlmCalls] = useState(0);
  const [kpis, setKpis] = useState({
    latency: 0, tokens: 0, cost: 0,
    accuracy:0, logicality: 0, storytelling: 0
  });
  const [mermaidGraphSyntax, setMermaidGraphSyntax] = useState(null);

  const eventSourceRef = useRef(null);



  // --- Load available providers on mount ---
  useEffect(() => {
    let isMounted = true;
    setIsLoadingModels(true);
    setError(null);

    fetch('/available_models')
      .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (!isMounted) return;
        const receivedProviders = data.available_providers_llm || {};
        setAvailableProviders(receivedProviders);
        const providerKeys = Object.keys(receivedProviders);
        const defaultProvider = providerKeys.includes("openai")
          ? "openai"
          : providerKeys[0] || '';
        setSelectedGlobalProvider(defaultProvider);
      })
      .catch(err => {
        if (!isMounted) return;
        setError("Failed to load available LLM providers from server. Check console for details.");
        setAvailableProviders({});
      })
      .finally(() => isMounted && setIsLoadingModels(false));

    return () => {
      isMounted = false;
      if (eventSourceRef.current) eventSourceRef.current.close();
    };
  }, []);

  // --- Universal SSE event handler ---
  function handleSSEEvent(event) {
    setLog(prev => [...prev, event.data]);
    try {
      const eventData = JSON.parse(event.data);
      const data = eventData.payload || eventData.data || {};

      switch(eventData.event_type) {
        case "final_report_generated":
          setReportUrl(data.report_url);
          // Optionally, show a toast or message using data.message
          break;

        case "company_data_extracted":
          setCompanyDetails({
            official_name: data.official_name,
            company_name: data.company_name,
            segments: data.segments,
            industry: data.industry,
            fmp_ticker: data.fmp_ticker,
            sec_ticker: data.sec_ticker,
            yfinance_ticker: data.yfinance_ticker,
            region: data.region,
            currency: data.currency,
            peers: data.peers
          });
          break;
        case 'setup_progress':
          if (data.step) {
            let statusKey = '';
            if (data.step.includes("Setting up APIs")) statusKey = "api";
            else if (data.step.includes("Setting up LLM Model")) statusKey = "llm";
            else if (data.step.includes("Setting up Agents")) statusKey = "agents";
            else if (data.step.includes("Setting up Tools")) statusKey = "tools";
            if (statusKey) setSetupStatus(prev => ({ ...prev, [statusKey]: "success" }));
          }
          break;
        case 'agent_end':
          if (data.agent_name === 'Get_Company_Details' && data.output?.status === 'company_found') {
            setSetupStatus(prev => ({ ...prev, region: "success" }));
            setNodeStatus(prev => ({ ...prev, Get_Company_Details: "completed" }));
          }
          break;
        case 'agent_start':
          setAgentSteps(prev => [
            ...prev,
            {
              id: `${data.agent_name}-${Date.now()}`,
              agentName: data.agent_name,
              toolName: 'Processing...',
              status: 'Running',
              duration: null
            }
          ]);
          // Mark the node as running
          if (data.agent_name) {
            const nodeName = data.agent_name.replace(/ /g, '_');
            setNodeStatus(prev => ({ ...prev, [data.agent_name]: "running" }));
          }
          break;
        case 'node_end':
          if (data.node === 'Get_Company_Details') {
            setNodeStatus(prev => ({
              ...prev,
              __start__: "completed",
              Get_Company_Details: "completed"
            }));
          }
          if (data.node) {
            setAgentSteps(prev => prev.map(step => {
              if (step.agentName === data.node && step.status === 'Running') {
                const toolsUsed = data.tools_used?.map(t => t.name).join(', ') || 'N/A';
                return {
                  ...step,
                  toolName: toolsUsed,
                  status: data.errors?.length > 0 ? 'Error' : 'Completed',
                  duration: data.duration ? data.duration * 1000 : null 
                };
              }
              return step;
            }));
            // Mark the node as completed or error
            const nodeName = data.node.replace(/ /g, '_');
            const newStatus = data.errors?.length > 0 ? "error" : "completed";
            setNodeStatus(prev => ({ ...prev, [nodeName]: newStatus }));
          }
          break;
        case 'tool_result':
          setAgentSteps(prev => prev.map(step =>
            step.id.startsWith(data.agent_name) && step.status === 'Running'
              ? {
                  ...step,
                  toolName: data.tool_name,
                  status: data.success ? 'Running' : 'Error'
                }
              : step
          ));
          setKpis(prev => ({
            ...prev,
            tool_calls: (prev.tool_calls || 0) + 1,
            successful_tool_calls: (prev.successful_tool_calls || 0) + (data.success ? 1 : 0)
          }));
          break;
        case 'llm_metrics':
          setLlmCalls(prev => prev + 1);
          setKpis(prev => ({
            ...prev,
            tokens: prev.tokens + (data.tokens || 0),
            cost: prev.cost + (data.cost || 0)
          }));
          break;
        case 'pipeline_end':
          setKpis(prev => ({
            ...prev,
            latency: data.latency, // ms to seconds
            tokens: data.tokens,
            cost: data.cost,
            accuracy: data.accuracy,
            logicality: data.logicality,
            storytelling: data.storytelling
          }));
          if (data.final_output) {
            const match = data.final_output.match(/report available at: (.*)/i);
            if (match && match[1]) setReportUrl(match[1]);
          }
          break;
        case 'graph_definition':
          if (eventData.payload && eventData.payload.mermaid_syntax) {
            setMermaidGraphSyntax(eventData.payload.mermaid_syntax);
          }
          break;
        case 'log':
          if (data.message) {
            const message = data.message;
            const toolCallMatch = message.match(/INFO:tools\.graph_tools:Calling tool: (\w+) with kwargs: /);
            if (toolCallMatch) {
              const toolName = toolCallMatch[1];
              setAgentSteps(prev => {
                const newSteps = [...prev];
                if (newSteps.length > 0) {
                  const lastRunningAgentIndex = newSteps.findIndex(step => step.status === 'Running');
                  if (lastRunningAgentIndex !== -1) {
                    newSteps[lastRunningAgentIndex] = {
                      ...newSteps[lastRunningAgentIndex],
                      toolName: toolName,
                    };
                  }
                }
                return newSteps;
              });
            }
          }
          break;
        default:
          // For unhandled events, keep logging for debug/trace.
          break;
      }
    } catch (e) {
      setLog(prev => [
        ...prev,
        `ERROR: ${event.data.substring(0, 100)}... (Parse Error: ${e.message})`
      ]);
    }
  }

  // --- Main SSE Runner ---
  // Purpose: Starts a new analysis run, resets only run-specific state, and manages the SSE connection.
  // This function should be called when the user clicks "Run Analysis".
  const startAnalysis = () => {
    setIsRunning(true);          // Show loading/progress state for the run
    setError(null);              // Clear any previous error
    setAgentSteps([]);           // Clear agent/tool execution steps
    setNodeStatus(initialNodeStatus); // Reset node status to default
    setEdgeStatus(initialEdgeStatus);      // Reset all edges to "pending"
    setLog([]);                  // Clear event log
    setLlmCalls(0);              // Reset LLM call count
    setReportUrl(null);          // Clear previous report URL
    setAgentSetup(null);         // Reset agent setup details
    setMermaidGraphSyntax(null); // Reset workflow graph
    setKpis({
      latency: 0,
      tokens: 0,
      cost: 0,
      accuracy: 0,
      logicality: 0,
      storytelling: 0,
    });                          // Reset KPIs to defaults
    setSetupStatus({
      api: "pending",
      llm: "pending",
      agents: "pending",
      tools: "pending",
      region: "pending"
    });                          // Reset setup progress indicators
    setNodeStatus({
      ...initialNodeStatus,
      __start__: "running"
    });



    // Close any existing SSE connection
    if (eventSourceRef.current) {
      eventSourceRef.current.close();
      eventSourceRef.current = null;
    }

    // Build backend streaming URL with current config
    const url = `/stream?company=${encodeURIComponent(company)}` +
                `&year=${year}` +
                `&report_type=${reportType}` +
                `&verbose=${verbose}` +
                `&provider=${encodeURIComponent(selectedGlobalProvider)}`;

    // Open new SSE connection
    const eventSource = new EventSource(url);
    eventSourceRef.current = eventSource;

    // Attach universal event handler to all event types (named and unnamed)
    eventSource.onmessage = handleSSEEvent;
    [
      'test_event', 'model_pricing_set', 'setup_progress', 'agent_setup', 'agent_end', 'agent_start',
      'node_end', 'tool_result', 'llm_metrics', 'pipeline_end', 'evaluation_metric',
      'pipeline_error', 'graph_definition', 'log'
    ].forEach(type => {
      eventSource.addEventListener(type, handleSSEEvent);
    });

    // Handle SSE errors
    eventSource.onerror = (e) => {
      if (!closedByComplete.current) {
        setError("Connection to server lost or failed to establish. Please check backend logs.");
      }
      setIsRunning(false);
      eventSource.close();
      closedByComplete.current = false;
    };

    // Handle pipeline completion
    eventSource.addEventListener('pipeline_complete', () => {
      closedByComplete.current = true;
      setIsRunning(false);
      eventSource.close();
    });
  };

  // --- Loading and Error UI Handling ---
  // Purpose: Only show the loading screen while models are being loaded.
  // After loading, always render the main UI. If there is an error, display it as a banner.

  if (isLoadingModels) {
    return (
      <div className="flex flex-col items-center justify-center h-screen">
        <IconSpinner />
        <span className="mt-2 text-gray-500">Loading available LLM providers...</span>
      </div>
    );
  }

  // --- Main Application Layout ---
  return (
    <div className="relative">
      {/* Agent Logo at Top Right */}
      <div className="absolute top-0 right-6">
        <img
          src="/doc/logo.png"
          alt="Agent Logo"
          style={{ height: "80px", width: "auto" }}
        />
      </div>

      <h1 className="text-2xl font-bold mb-6">
        RoboFinGraph Agent : Financial Analyser
      </h1>

      <div className="flex flex-col md:flex-row gap-6">
        {/* Left Sidebar */}
        <div className="md:w-1/5 flex flex-col gap-4">
          <AnalysisConfig
            company={company} setCompany={setCompany}
            year={year} setYear={setYear}
            reportType={reportType} setReportType={setReportType}
            selectedGlobalProvider={selectedGlobalProvider} setSelectedGlobalProvider={setSelectedGlobalProvider}
            availableProviders={availableProviders}
            isRunning={isRunning}
            onStart={startAnalysis}
            verbose={verbose} setVerbose={setVerbose}
          />
          <LoggingSetupStatus setupStatus={setupStatus} />
        </div>

        {/* Middle Section */}
        <div className="md:w-2/5 flex flex-col gap-4">
          <CompanyDetails details={companyDetails} />
          <PipelineKPIs kpis={kpis} reportUrl={reportUrl} />
          <AgentToolTable agentSteps={agentSteps} />
          <RawEventLog log={log} />
        </div>

        {/* Right Sidebar */}
        <div className="md:w-2/5 flex flex-col gap-4">
          <GraphViewer mermaidSyntax={mermaidSyntax} />
          {reportUrl && (
            <div className="bg-green-100 border border-green-400 text-green-800 rounded p-4 mb-4 flex items-center justify-between">
              <span className="font-semibold">Final Report Generated!</span>
              <a
                href={reportUrl}
                target="_blank"
                rel="noopener noreferrer"
                className="ml-4 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-semibold"
              >
                Show Final Report (PDF)
              </a>
            </div>
          )}
        </div>
      </div>

      {/* Error Banner */}
      {error && (
        <div className="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-md">
          {error}
        </div>
      )}
    </div>
  );



} // Ends App

// ============================================================================
// RENDER THE MAIN APP COMPONENT
// Starts: here
// Purpose: Mounts the React app into the root div
// Ends: at end of script
// Closed by: no explicit block (single statement)
// ============================================================================

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
{% endraw %}
</body>
</html>
